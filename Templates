# Construct the SQL query
query = """
WITH last_period AS (
    SELECT 
        CASE 
            WHEN MONTH(CURRENT_DATE) >= 7 THEN YEAR(CURRENT_DATE)
            ELSE YEAR(CURRENT_DATE) - 1
        END AS start_year,
        CASE 
            WHEN MONTH(CURRENT_DATE) >= 7 THEN 1
            ELSE 7
        END AS start_month,
        CASE 
            WHEN MONTH(CURRENT_DATE) >= 7 THEN 6
            ELSE 12
        END AS end_month
)
SELECT *
FROM pme_agg_data
WHERE (EXECUTION_YEAR = (SELECT start_year FROM last_period)
       AND EXECUTION_MONTH BETWEEN (SELECT start_month FROM last_period) AND (SELECT end_month FROM last_period));
"""

# Run the SQL query and load the data into a DataFrame
new_data = spark.sql(query)

# Proceed with further transformations and aggregation as needed
